{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    {%  block extrahead %}
    {% endblock %}

    <style>
        .loader { 
        position: fixed;
        left: 0px;
        top: 0px;
        width: 100%;
        height: 100%;
        z-index: 9999;
        background: url('/media/img/load.gif') 50% 50% no-repeat rgb(249,249,249);
        opacity: .8;
    }

    .form-popup {
      display: none;
      position: fixed;
      /* bottom: 1; */
      top: 50px;
      right: 15px;
      border: 3px solid #f1f1f1;
        /* transition: all 300ms ease 0ms;
        box-shadow: 0px 8px 15px rgba(0, 0, 0, 0.1); */
      z-index: 99;
    }

    .form-container {
      max-width: 400px;
      max-height: 500px;
      padding: 10px;
      background-color: white;
    }

    .form-container-login {
      max-width: 200px;
      padding: 10px;
      background-color: white;
    }

    .form-container input[type=text], .form-container input[type=password] {
      width: 100%;
      padding: 15px;
      margin: 5px 0 22px 0;
      border: none;
      background: #f1f1f1;
    }

    .form-container input[type=text]:focus, .form-container input[type=password]:focus {
      background-color: #ddd;
      outline: none;
    }

    .list-group{
      max-height: 450px;
      margin-bottom: 10px;
      /* overflow:scroll; */
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* .form-container .btn {
      background-color: #04AA6D;
      color: white;
      padding: 16px 20px;
      border: none;
      cursor: pointer;
      width: 100%;
      margin-bottom:10px;
      opacity: 0.8;
    } */

    /* .form-container .cancel {
      background-color: red;
    } */

/* Add some hover effects to buttons */
/* .form-container .btn:hover, .open-button:hover {
      opacity: 1;
    } */

    @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css");

    </style>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{%  block tittle %} Sistema Ecofroz {% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/tercer_menu.css' %}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <!-- <link rel="stylesheet" href="/resources/demos/style.css"> -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="{% static 'css/icon.css' %}">
    <link rel="stylesheet" href="{% static 'css/alternativo.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}" />

   
    
    <!-- <link rel ="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.css" /> -->
   
</head>
<body>
  {% if request.path != '/landing' %}
    {% if request.path != '/' %}
      {% include "menu.html" %}
    {% endif %} 
  {% endif %}
  <div class="container-fluid"></div>
  {% block content %}
  {% endblock %}    
  </div>
  {% include "login.html" %}


  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.10/jquery.mask.js"></script>
  <!-- <script src="https://raw.githubusercontent.com/tuupola/jquery_chained/master/jquery.chained.remote.min.js"></script> -->
  <!-- <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script> -->

  <script src="{% static 'js/add-formset.js' %}"></script>
  <!-- <script src="{% static 'js/jquery.chained.js' %}"></script> -->
  <script src="{% static 'js/js.cookie.js' %}"></script>
  <script src="{% static 'js/dynamic-formset.js' %}"></script>
  <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
  <script src="{% static 'js/doubletaptogo.js' %}"></script>

  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.js"></script> -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.6/index.global.min.js"></script> -->

  {% block extrajs %}
  {% endblock %}

  <script type="text/javascript">

	  document.addEventListener("DOMContentLoaded", function(){
        /////// Prevent closing from click inside dropdown
      document.querySelectorAll('.dropdown-menu').forEach(function(element){
        element.addEventListener('click', function (e) {
          e.stopPropagation();
        });
      })

      // make it as accordion for smaller screens
      if (window.innerWidth < 992) {
        // close all inner dropdowns when parent is closed
        document.querySelectorAll('.navbar .dropdown').forEach(function(everydropdown){
          everydropdown.addEventListener('hidden.bs.dropdown', function () {
            // after dropdown is hidden, then find all submenus
              this.querySelectorAll('.submenu').forEach(function(everysubmenu){
                // hide every submenu as well
                everysubmenu.style.display = 'none';
              });
          })
        });
        
        document.querySelectorAll('.dropdown-menu a').forEach(function(element){
          element.addEventListener('click', function (e) {
      
              let nextEl = this.nextElementSibling;
              if(nextEl && nextEl.classList.contains('submenu')) {	
                // prevent opening link if link needs to open dropdown
                e.preventDefault();
                console.log(nextEl);
                if(nextEl.style.display == 'block'){
                  nextEl.style.display = 'none';
                } else {
                  nextEl.style.display = 'block';
                }
  
              }
          });
        })
      }
      // end if innerWidth
  
    }); 
    // DOMContentLoaded  end

    
    function login() {
      document.getElementById("myForm").style.display = "block";
    }

    function logout() {
      document.getElementById("myForm2").style.display = "block";
      $("#profile").removeAttr("onclick");
      $("#profile").attr("onclick", "closeForm('myForm2')");
      var par = $("#notificaciones");
      var stldis = par[0].style["display"]
      console.log(stldis)
      if (stldis == 'block'){
        document.getElementById("notif").click();
      }
    }

    function noti(accion){
      if (accion == "open"){
        $("#notif").removeAttr("onclick");
        $("#notif").attr("onclick", "noti('close')");
        document.getElementById("notificaciones").style.display = "block";
        
        var par = $("#myForm2");
        var stldis = par[0].style["display"]
        
        if (stldis == 'block'){
          document.getElementById("profile").click();
        }

      }else{
        document.getElementById("notificaciones").style.display = "none";
        $("#notif").removeAttr("onclick");
        $("#notif").attr("onclick", "noti('open')");
      }
      
    }

    function closeForm(accion) {
      if (accion){
        document.getElementById(accion).style.display = "none";
      $("#profile").removeAttr("onclick");
      $("#profile").attr("onclick", "logout()");
      }else{
        document.getElementById("myForm").style.display = "none";
      }
      
    }

    function notificaciones(){
      var lista = $("#noti");
      var not = $("#notif");
      var noti = "";
      var options = "";
      var est = "";
      $.ajax({
        url:"{% url 'parametrosglobales:notificaciones' %}",
        type: "GET",
        data: {
            // 'action': 'search_ubica',
            // 'id': id,
            // 'csrfmiddlewaretoken': '{{ csrf_token }}',
        },
        dataType: "json",
      }).done(function (data) {
        if (!data.hasOwnProperty("error")){
            $.each((data), function(key, value){
                // options += "<option value='" + value.id + "'>" + value.name + "</option>"
                if (value.estado == true){
                  est = 'SI';
                  options += `<div class='list-group-item list-group-item-action list-group-item-info' style='text-align:left'${value.id}'>${value.fec}. ${value.abrev}: ${value.id}. ${value.solic}. ${value.desc}
                              <span><button class='btn badge rounded-pill btn-danger' id='ver' value='${value.nid}' onclick="desactivanot(this.value, this.getAttribute('id'))">&nbsp;Ver&nbsp;</button>
                              <a class='btn badge rounded-pill btn-success' href='${value.url_2}'>Listar</a>
                              <button class='btn badge rounded-pill btn-info' id='leido' value='${value.nid}' onclick="desactivanot(this.value, this.getAttribute('id'))">&nbsp;Leido&nbsp;</button></span></div>`
                  // options += "<div class='list-group-item list-group-item-action list-group-item-info' style='text-align:left'" + value.id + "'>" + value.fec + ". " + value.abrev + ": " + value.id + ". " + value.solic + ". " + value.desc  + "\
                  //             <span><button class='btn badge rounded-pill btn-danger' id='ver' value='" + value.nid + "'>&nbsp;Ver&nbsp;</button>\
                  //             <a class='btn badge rounded-pill btn-success' href='" + value.url_2 + "'>Listar</a>\
                  //             <button class='btn badge rounded-pill btn-info' id='leido' value='" + value.nid + "' onclick='desactivanot(this.value, this.getAttribute('id'))'>&nbsp;Leido&nbsp;</button></span></div>"
                } else{
                  options += `<div class='list-group-item list-group-item-action' style='text-align:left'> ${value.fec}. ${value.abrev}: ${value.id}. ${value.solic}. ${value.desc}
                              <span><button class='btn badge rounded-pill btn-danger' id='ver' value='${value.nid}' onclick="desactivanot(this.value, this.getAttribute('id'))">&nbsp;Ver&nbsp;</button>
                              <a class='btn badge rounded-pill btn-success' href='${value.url_2}'>Listar</a></span></div>`;
                  // options += "<div class='list-group-item list-group-item-action' style='text-align:left'>"+ value.fec + ". " + value.abrev + ": " + value.id + ". " + value.solic + ". " + value.desc + "\
                  //             <span><button class='btn badge rounded-pill btn-danger' id='ver' value='" + value.nid + "'>&nbsp;Ver&nbsp;</button>\
                  //             <a class='btn badge rounded-pill btn-success' href='" + value.url_2 + "'>Listar</a></span></div>";
                }
                
                // document.getElementById('ver' + value.nid).onclick = desactivanot(this.value, this.getAttribute('id'));
                // $("#ver" + value.nid).attr("onclick", "desactivanot(this.value, this.getAttribute('id'))");
                console.log(value.id + ": " + value.desc)
                console.log(value.nid)
            });
            if (est == 'SI'){
              noti = "<span class='position-absolute top-60 start-60 translate-middle p-1 bg-danger border border-light rounded-circle'>\
                      <span class='visually-hidden'>New alerts</span>\
                      </span>";
            } else {
              noti = "";
            }
            // var dat = jQuery.parseJSON(data);
            // $.each(dat, function(i, item){
            //   console.log(item.fields.usuario_activa);
            // })
            // console.log(data)
            return false;
        }
      }).fail(function (jqXHR, textStatus, errorThrown ) {
        console.log(textStatus + ': ' + errorThrown);
      }).always(function (data) {
          lista.html(options);
          not.html(noti);
      })

      // setTimeout(notificaciones, 30000)
    }

    $(document).ready(function(){
      notificaciones();
    })



    function desactivanot(id, idatr) {
      console.log(id + ' ' + idatr)
      $.ajax({
        url:"{% url 'parametrosglobales:desactivanotif' %}",
        type: "GET",
        data: {
          'id': id,
        },
        dataType: "json",
      }).done(function (data) {
        if (!data.hasOwnProperty("error")){
          console.log(data)
          if (idatr == 'ver'){
            $.each(data, function(key, value){
              $(location).attr('href', value.url_1 + value.id);
            })
          } else {
            notificaciones();
          }
          
          // location.href = '/trabajos/generarcompra/' + id;
          
          return false;
        }
      }).fail(function (jqXHR, textStatus, errorThrown ) {
        alert(textStatus + ': ' + errorThrown);
      }).always(function (data) {
      })    
    }

    $("#ver").click(function(event){
      valor = this.value;
      id = this.id;
    })

  </script>
</body>
</html>
